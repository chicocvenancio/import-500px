{% extends "base.html" %}
{% block extra_scripts %}
{{ super() }}
<link rel="stylesheet" href="//tools-static.wmflabs.org/cdnjs/ajax/libs/noty/3.1.4/noty.min.css" />
<script src="//tools-static.wmflabs.org/cdnjs/ajax/libs/noty/3.1.4/noty.min.js"></script>
{% endblock %}
{% block before_header %}
<div class="btn-group pull-right">
  <button type="button" class="btn btn-default dropdown-toggle " data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    Internet Archive<span class="caret"></span>
  </button>
  <ul class="dropdown-menu cdn-source">
    <li><a href="#" value="Internet Archive">Internet Archive</a></li>
    <li><a href="#" value="500px">500px</a></li>
  </ul>
</div>
{% endblock %}
{% block extra_content %}
<div class="modal fade" id="privacyModal" tabindex="-1" role="dialog" aria-labelledby="privacyModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="myModalLabel">Privacy Warning</h4>
      </div>
      <div class="modal-body">
        This tool loads images from the Internet Archive by default. This will give them access to your private information, 
        such as ip address and User Agent and their handling of your information is subject to the their
        <a href="https://archive.org/about/terms.php">terms of use and privacy
            policy</a>. Note there is an option to use the 500px CDN on the top
        right, choosing that will 500px access to the same type of personal
        data and is subject to their <a href="https://about.500px.com/terms/">terms of use</a>
        and <a href="https://about.500px.com/privacy/">privacy policy</a>.
      </div>
      <div class="modal-footer">
        <button id="privacy_out" type="button" class="btn btn-default" data-dismiss="modal">Do not load the images</button>
        <button id="privacyOK" type="button" class="btn btn-primary" data-dismiss="modal">I'm Ok with that (bring the photos)</button>
      </div>
    </div>
  </div>
</div>
<script>
var page = {{page}}, cdn_source = "Internet Archive", get_images, get_license, make_popovers;
get_images = function(page, perpage){
    $.getJSON("https://tools.wmflabs.org/import-500px/{{page_name}}/" + page +
            '?perpage=' + perpage).done(
        function (data) { 
            $('#content').html('');
            data.forEach(function (photo) {
                var url, $photo, opacity_class;
                opacity_class = '';
                //console.log(photo.author);
                if (photo.low_res_url){
                    url = photo.low_res_url;
                } else {
                    url = photo.url;
                }
                if (cdn_source === "Internet Archive") {
                    url = 'https://web.archive.org/web/201807id_/' + url;
                } else if (cdn_source !== "500px") {
                    url = "";
                }
                if (photo.commons_name) {
                    opacity_class = " on_commons";
                }
                $photo = $('<div data-photo-id="' + photo.id +
                           '" data-author-id="' + photo.author_id +
                           '" data-author="' + decodeURIComponent(photo.author) +
                           '" data-commons-name="' + photo.commons_name +
                           '" data-comments="' + photo.comments +
                           '" tabindex="0" class="col-md-3 photo_div btn' +
                           opacity_class + '">' + '<img class="img-responsive" src=' +
                            url + '> by ' + decodeURIComponent(photo.author) + '. License: ' +
                            get_license(photo.license) + '</div>');
                $('#content').append($photo);

            });
            make_popovers();
        }
    );
};
get_license = function (license_int) {
    var license_map = {
        4: 'CC-BY 3.0',
        6: 'CC-BY-SA 3.0',
        7: 'PDM (Public Domain Mark)',
        8: 'CC0'
    };
    return license_map[license_int]
};
$('#privacyModal').modal();
$('#privacy_out').click(function () {
    $('.pagination').html('');
});
$('#privacyOK').click(function () {
    get_images(page, {{perpage}});
    history.pushState({'page': page}, "page " + page, "?page=" + page +
        "&perpage=" + {{perpage}});
});
$('.pagination').twbsPagination({
    totalPages: {{total_pages}},
   startPage: page,
   visiblePages: 10,
   initiateStartPageClick: false,
   onPageClick: function (event, page) {
        get_images(page, {{perpage}});
        history.pushState({'page': page}, "page " + page, "?page=" + page +
            "&perpage=" + {{perpage}});
   }
});
make_popovers = function() {
    $('.photo_div').popover({
        html: true,
        trigger: 'click',
        title: function() {
            var author_id, comments, commons_file;
            author_id = $(this).data('authorId');
            comments = '';
            commons_file = '';
            if ($(this).data('comments')) {
                comments = JSON.parse($(this).data('comments'));
            }
            if ($(this).data('commonsName')) {
                commons_file = ' <a href="//commons.wikimedia.org/wiki/File:' +
                    $(this).data('commonsName') + '" class="bg-success"> File' +
                    ' on Commons</a>'
            }
            return '<a href="/import-500px/photo/' + $(this).data('photoId') +
                   '"> Photo ' + $(this).data('photoId') + '</a>' +
                   ' <a href="/import-500px/author/' +
                    author_id + '">by ' + $(this).data('author') + '</a>' +
                    commons_file
        },
        content: function() {
            var buttons;
            buttons = '';
            if (!$(this).data('commonsName')){
                buttons = '<button type="button" class="btn btn-primary" ' +
                    'id=upload_' + $(this).data('photoId') + 
                    ' data-photo-id="' + $(this).data('photoId') + 
                    '">' + 'Upload to Commons</button>';
            }
            $.getJSON('https://tools-static.wmflabs.org/import-500px/' +
                $(this).data('photoId') + '.json').done(
                function (data){
                    delete data.images;
                    delete data.image_url;
                    $('#popover_' + data.id).html('<pre>' + 
                        JSON.stringify(data, undefined, 2) + '</pre>');
                    $('#upload_' + data.id).click( function (event) {
                        $.ajax({
                            method: "POST",
                            url: "/import-500px/upload/" + $(this).data('photoId'), 
                            dataType: "json"
                        }).done(function (data, s) {
                            if (data.result === "Success") {
                                new Noty({
                                    "type": "success",
                                    "text": "File:" + data.filename +
                                    " successfully uploaded to Commons!"
                                }).show();
                            }
                        }).fail(function (data, s) {
                            console.log(data, s);
                            if (data.status === 403) {
                                new Noty({
                                    "type": "error",
                                    "text": "There was a permission error " +
                                    "with the upload, try relogging with OAuth"
                                }).show();
                            }
                        });
                    });
                });
        return buttons + '<div id=popover_' + $(this).data('photoId') +
                '>LOADING json</div>'
        },
        placement: 'auto right'});
 }
$('.cdn-source a').click(function(){
    cdn_source = $(this).attr('value');
    $('.dropdown-toggle').text(cdn_source);
});
</script>
<style type="text/css">
    .popover{
        max-width:600px;
        min-width:400px;
    }
    .on_commons{
        opacity: 0.5;
    }
</style>
{% endblock %}
